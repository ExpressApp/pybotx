"""Definition of Starlette application that is mock for BotX API."""

from typing import Any, Callable, Dict, List, Sequence, Tuple, Type

from molten import App, JSONParser, Route, Settings, SettingsComponent

from botx.clients.methods.base import BotXMethod
from botx.testing.botx_mock.wsgi.errors import error_middleware
from botx.testing.botx_mock.wsgi.routes import bots  # noqa: WPS235
from botx.testing.botx_mock.wsgi.routes import (
    chats,
    command,
    events,
    files,
    notification,
    notifications,
    stickers,
    users,
)
from botx.testing.typing import APIMessage, APIRequest

_ENDPOINTS: Tuple[Callable[..., Any], ...] = (
    # V2
    # bots
    bots.get_token,
    # V3
    # chats
    chats.get_info,
    chats.get_bot_chats,
    chats.post_add_admin_role,
    chats.post_add_user,
    chats.post_remove_user,
    chats.post_stealth_set,
    chats.post_stealth_disable,
    chats.post_create,
    chats.post_pin_message,
    chats.post_unpin_message,
    # command
    command.post_command_result,
    # events
    events.post_edit_event,
    # notification
    notification.post_notification,
    notification.post_notification_direct,
    # users
    users.get_by_huid,
    users.get_by_email,
    users.get_by_login,
    # notifications
    notifications.post_internal_bot_notification,
    # files
    files.upload_file,
    files.download_file,
    # stickers
    stickers.get_sticker_pack_list,
    stickers.get_sticker_pack,
    stickers.get_sticker_from_sticker_pack,
    stickers.post_add_sticker_into_sticker_pack,
    stickers.post_delete_sticker_pack,
    stickers.delete_sticker_from_sticker_pack,
    stickers.post_create_sticker_pack,
    stickers.post_edit_sticker_pack,
)


def _create_molten_routes() -> Sequence[Route]:
    routes = []

    for endpoint in _ENDPOINTS:
        url = endpoint.method.__url__  # type: ignore # noqa: WPS609
        method = endpoint.method.__method__  # type: ignore # noqa: WPS609
        routes.append(Route(url, endpoint, method=method))

    return routes


def get_botx_wsgi_api(
    messages: List[APIMessage],
    requests: List[APIRequest],
    errors: Dict[Type[BotXMethod], Tuple[int, Any]],
) -> App:
    """Generate BotX API mock.

    Arguments:
        messages: list of message that were sent from bot and should be extended.
        requests: all requests that were sent from bot.
        errors: errors to be generated by mocked API.

    Returns:
        Generated BotX API mock for using with httpx.
    """
    return App(
        components=[
            SettingsComponent(
                Settings(messages=messages, requests=requests, errors=errors),
            ),
        ],
        routes=list(_create_molten_routes()),
        middleware=[error_middleware],
        parsers=[JSONParser()],
    )
